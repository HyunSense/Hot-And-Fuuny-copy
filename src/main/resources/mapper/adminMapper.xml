<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.choongang.concert.mapper.admin.AdminMapper">





<select id="getUserList" parameterType="com.choongang.concert.dto.admin.PageDto" resultType="com.choongang.concert.dto.admin.UserInfoDTO">
    SELECT
        *
    FROM
        user
    ORDER BY
        id DESC
    LIMIT #{paginationDto.limitStart}, #{recordSize}
</select>
    


    <!-- 게시글 수 카운팅 -->
    <select id="count" parameterType="com.choongang.concert.dto.admin.PageDto" resultType="int">
        SELECT
            COUNT(*)
        FROM
            user
    </select>



	<!-- statics.html에 필요한 sql 쿼리들-->
	
	<!-- SecondDonut 차트 (연령대별 통계) -->
	<select id="ageGroup" parameterType="com.choongang.concert.dto.admin.SecondDonutDto" resultType="int">
		SELECT COUNT(age) AS ageGroup FROM user WHERE age BETWEEN 10 AND 19 UNION ALL
		SELECT COUNT(age) FROM user WHERE age BETWEEN 20 AND 29 UNION ALL
		SELECT COUNT(age) FROM user WHERE age BETWEEN 30 AND 39 UNION ALL
		SELECT COUNT(age) FROM user WHERE age BETWEEN 40 AND 109
	</select>
		

	<!-- Bar 차트 (예매율 통게) -->
	<select id="reservationGroup" parameterType="com.choongang.concert.dto.admin.BarDto" resultType="int">
SELECT COUNT(concert_id) AS reservationGroup FROM ticket WHERE concert_id = 1 union all
		SELECT COUNT(concert_id) FROM ticket WHERE concert_id = 2 union all
		SELECT COUNT(concert_id) FROM ticket WHERE concert_id = 3;
	</select>
	
	<!-- Bar2 차트 (실시간 좌석 통게) -->
    <resultMap id="bar2DtoResultMap" type="com.choongang.concert.dto.admin.Bar2Dto">
        <id property="concert_id" column="concert_id"/>
        <result property="firstConDay" column="firstConDay"/>
        <result property="secondConDay" column="secondConDay"/>
        <result property="thirdConDay" column="thirdConDay"/>
    </resultMap>

    <select id="seatGroup" resultMap="bar2DtoResultMap">
        SELECT t.concert_id,
               SUM(CASE WHEN s.seat_type = 'R' THEN 1 ELSE 0 END) AS firstConDay,
               SUM(CASE WHEN s.seat_type = 'S' THEN 1 ELSE 0 END) AS secondConDay,
               SUM(CASE WHEN s.seat_type = 'Vip' THEN 1 ELSE 0 END) AS thirdConDay
        FROM ticket t 
        LEFT OUTER JOIN seat s ON t.seat_number = s.seat_number
        GROUP BY t.concert_id;
    </select>
	
	
	<!-- Donut 차트 (성비별 통게) -->
	<select id="genderGroup" parameterType="com.choongang.concert.dto.admin.DonutDto" resultType="int">
		select count(id) as genderGroup from user where gender=0 union all
		select count(id) from user where gender=1;
	</select>
	
	
	<!-- Area 차트 (매출 현황) -->
	<select id="areaGroup" parameterType="com.choongang.concert.dto.admin.AreaDto" resultType="com.choongang.concert.dto.admin.AreaDto">
		SELECT
    		t.concert_id AS concertDate,
    			SUM(CASE WHEN t.discount_yn = 1 THEN s.price * 0.7 ELSE s.price END) AS total_price
		FROM
		    ticket AS t
		JOIN
		    seat AS s ON t.seat_number = s.seat_number
		GROUP BY
		    t.concert_id
	</select>
	
	
	<!--				 보드 컨트롤 				-->
	
	<!--		전체 게시판 관리		-->
		<!-- 전체 게시물 조회 -->
	
	<select id="getTotalList" parameterType="com.choongang.concert.dto.admin.TotalPostDto" resultType="com.choongang.concert.dto.admin.TotalPostDto">
		SELECT nb.id, title, content, category AS boardType, nb.id as boardId, created_at AS date
		FROM notice_board nb
		WHERE nb.delete_yn = 0
		UNION all
		SELECT qb.id, title, content, category AS boardType, qb.id as boardId, created_at AS date
		FROM qna_board qb
		WHERE qb.delete_yn = 0
		UNION all
		SELECT eb.id, title, content, category AS boardType, eb.id  as boardId, created_at As date
		FROM event_board eb
		WHERE eb.delete_yn = 0
		ORDER BY id DESC;
	</select>
	
		<!-- 전체 게시물 삭제 버튼 -->
	

	
	
		<!-- 전체게시물삭제버튼디비까지 -->
<update id="deleteEventBoard" parameterType="com.choongang.concert.dto.admin.TotalPostDto">
    UPDATE event_board AS e
    SET e.delete_yn = CASE WHEN e.category = '이벤트' THEN 1 ELSE e.delete_yn END
    WHERE (e.id, e.category) IN
    <foreach collection="list" item="totalPost" open="(" separator="," close=")">
        (#{totalPost.id}, '이벤트')
    </foreach>
</update>

<!-- Q&A 보드 업데이트 -->
<update id="deleteQnaBoard" parameterType="com.choongang.concert.dto.admin.TotalPostDto">
    UPDATE qna_board AS q
    SET q.delete_yn = CASE WHEN q.category = 'qna' THEN 1 ELSE q.delete_yn END
    WHERE (q.id, q.category) IN
    <foreach collection="list" item="totalPost" open="(" separator="," close=")">
        (#{totalPost.id}, 'qna')
    </foreach>
</update>

<!-- 노티스 보드 업데이트 -->
<update id="deleteNoticeBoard" parameterType="com.choongang.concert.dto.admin.TotalPostDto">
    UPDATE notice_board AS n
    SET n.delete_yn = CASE WHEN n.category = '노티스' THEN 1 ELSE n.delete_yn END
    WHERE (n.id, n.category) IN
    <foreach collection="list" item="totalPost" open="(" separator="," close=")">
        (#{totalPost.id}, '노티스')
    </foreach>
</update>

	<!--		qna 게시판 관리		-->

	
	
	<!-- qna 게시물 조회 -->
	<select id="getQnaList" parameterType="com.choongang.concert.dto.admin.QnaPostDto" resultType="com.choongang.concert.dto.admin.QnaPostDto">
		select q.id AS id, title, content, created_at AS Date, u.nickname AS writer
		from qna_board q left outer join `user` u
		on q.user_id = u.id
		WHERE q.delete_yn = 0
	</select>
	


	<!-- qna 게시물 삭제 -->
	<update id="deleteQna" parameterType="List">
	    update qna_board
	    set delete_yn = 1
	    where id in
	    <foreach collection="list" item="id" open="(" separator="," close=")">
	        #{dataForm}
	    </foreach>
	</update>
	
	<update id="resDelete" parameterType="java.util.List">
	    update qna_board
	    set delete_yn = 1
	    where id in
	    <foreach collection="list" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	</update>
	
	
	
	
	<!-- 				refund				 -->
	<select id="getRefundList" parameterType="List">
select distinct t.ticket_name AS ticket, u.name AS name, u.nickname AS nickname, u.tel AS tel
from ticket t
left outer join user u on t.user_id = u.id 
where t.status = 'WAITING';
	</select>
	
	
	<select id="getRefundData" parameterType="com.choongang.concert.dto.admin.RefundDto">
		delete t
		from ticket t
		left outer join user u on t.user_id = u.id 
		WHERE u.nickname = '${nickname}' AND u.name = '${name}' AND t.status = 'WAITING';
	</select>
	
	<!--u.nickname = ${nickname} AND u.name = ${name} AND -->
</mapper>